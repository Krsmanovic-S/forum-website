{% macro render_comment(comment, indent=0, user_votes=None, current_user=None) %}
<div id="redirect-{{ comment.id }}" class="mb-3 ms-{{ indent }} shadow-sm post-card mt-3">
  <div class="card-body p-3">
    <span class="d-flex align-items-center mb-2">
      <img src="{{ url_for('static', filename='assets/profile_images/' + comment.comment_author.username + '.png') }}"
           alt="Profile Image" class="rounded-circle" width="25px" height="25px"
           onerror="this.onerror=null; this.src='{{ url_for('static', filename='assets/profile_images/default-profile.png') }}'">
      <a class="nav-link px-2 text-body-secondary ms-2"
         href="{{ url_for('profile', profile_username=comment.comment_author.username) }}">
        {{ comment.comment_author.username }}
      </a>
    </span>

    <p class="mb-1">{{ comment.text }}</p>

    <div class="d-flex align-items-stretch">
      <!-- Upvotes & Downvotes-->
      <div class="d-flex px-3 py-1 rounded-pill upvote-section">
        <form method="POST" action="{{ url_for('vote_comment', comment_id=comment.id, action='upvote') }}">
          <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent"
                  style="color: {% if user_votes and user_votes.get(comment.id) == 1 %} orange {% else %} white {% endif %};">
            ▲
          </button>
        </form>

        <div class="text-light mx-2">{{ comment.score }}</div>

        <form method="POST" action="{{ url_for('vote_comment', comment_id=comment.id, action='downvote') }}">
          <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent"
                  style="color: {% if user_votes and user_votes.get(comment.id) == -1 %} deepskyblue {% else %} white {% endif %};">
            ▼
          </button>
        </form>
      </div>

      <!-- Reply Button -->
      <div class="d-flex align-items-end ms-2">
        <input type="checkbox" id="reply-toggle-{{ comment.id }}" class="reply-toggle" hidden>
        <label for="reply-toggle-{{ comment.id }}"
               class="btn btn-sm btn-outline-secondary mb-0 reply-toggle-button"
               data-comment-id="{{ comment.id }}">
          Reply
        </label>
      </div>
    </div>

    <!-- Reply Form -->
    {% if current_user.is_authenticated %}
    <form method="POST" class="mt-3" action="{{ url_for('reply_comment', post_id=comment.parent_post.id, parent_comment_id=comment.id) }}"
          style="display:none;" id="reply-form-{{ comment.id }}">
      <div class="mb-3">
        <textarea class="form-control input-form" name="text" rows="1" placeholder="Reply..." required style="text-align: left;"></textarea>
      </div>
      <div class="d-flex justify-content-end" style="display: none;">
        <button type="submit" class="btn btn-outline-secondary">Reply</button>
      </div>
    </form>
    {% endif %}

    <!--  Replies -->
    {% for reply in comment.replies %}
      {{ render_comment(reply, indent + 1, user_votes, current_user) }}
    {% endfor %}
  </div>
</div>
{% endmacro %}
